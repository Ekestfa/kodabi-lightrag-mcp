## Requirement: `HTTP Access to the local LightRag`
- **ID**: REQ202511272348
- **Name**: `HTTP Access to the local LightRag`
- **Description**: The integration of LightRAG `/query` API to server.
- **MoSCoW**: Must-have
- **Verification Methods**: Unit test, UAT

### User Story
**User Story ID: ID: REQ202511272348-01**
```REQ202511272348-01
As a [LightRAG user],
I want [query different RAG microservices with specified port numbers],
so that [I can create a RAG microservices and query from different microservices only using the one server].

for example:
- Software Engineering RAG: [..0:8080]
- History RAG: [..0:8081] etc.
```
**User Story ID: REQ202511272348-02**
```REQ202511272348-02
As a [LightRAG user],
I want [web servers could be checked whether server up via `/health` API],
so that [I can start my workflow with RAG].
```
**User Story ID: REQ202511272348-03**
```REQ202511272348-03
As a [LightRAG user],
I want [a web server, that can send request to the `/query` API],
so that [I can query my data from RAG].
```
**User Story ID: ID: REQ202511272348-04**
```REQ202511272348-04
As a [LightRAG user],
I want [query different RAG microservices with only context],
so that [I can create a RAG microservices and query and obtain data from different microservices for one question].
```
**User Story ID: ID: REQ202511272348-05**
```REQ202511272348-05
As a [LightRAG user],
I want [query different RAG microservices with specified calling order with specified user prompt and query question],
so that [I can create a RAG microservices and query from different microservices only using the one server].
```
**User Story ID: ID: REQ202511272348-05**
```REQ202511272348-05
As a [LightRAG user],
I want [query different RAG microservices with different roles],
so that [I can create a agentic RAG microservices].
```

### Acceptance Criteria
#### REQ202511272348-US01
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** a user has configured a central RAG server with access to multiple RAG microservices, each running on a distinct port (e.g., Software Engineering RAG on port 8080, History RAG on port 8081)
    - **When** the user sends a query to the central RAG server specifying a microservice name and its associated port number
    - **Then** the server routes the query to the correct microservice using the specified port, retrieves context from that microservice's vector database, and returns a contextual response with source document information
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** a user has configured a central RAG MCP server with access to multiple RAG microservices
    - **When** the user sends a query to the central RAG MCP server specifying a microservice name but an invalid or non-existent port number
    - **Then** the server returns a response indicating the port number is invalid or the microservice is not available, with a clear error message that includes the invalid port number
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** a user has configured a central RAG MCP server with access to multiple RAG microservices
    - **When** the user sends a query to the central RAG MCP server with a microservice name that does not exist in the configured list of microservices
    - **Then** the server returns a response stating that the requested microservice is not found, and lists all available microservices with their port numbers
- **AC04:** [Negative Test - Error Condition]
    - **Given** a user has configured a central RAG MCP server with access to multiple RAG microservices
    - **When** the user sends a query to the central RAG MCP server with a malformed or missing port number parameter
    - **Then** the server should respond with an appropriate error message indicating the port number is required and must be specified, and should not attempt to connect to any microservice
#### REQ202511272348-US02
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** the web server is running and the `/health` API endpoint is active
    - **When** a request is made to the `/health` endpoint via HTTP GET
    - **Then** the server returns a `200 OK` response indicating it is up and healthy, allowing the workflow to proceed with RAG operations
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** the web server is down or the `/health` endpoint is misconfigured
    - **When** a request is made to the `/health` endpoint
    - **Then** the server returns a `503 Service Unavailable` or a `404 Not Found` response, and the workflow is halted with a clear error message indicating that the server is not available
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** the `/health` endpoint returns a non-JSON response or a malformed response
    - **When** a request is made to the `/health` endpoint
    - **Then** the system logs a warning and treats the response as invalid, triggering a fallback mechanism to check alternative health endpoints or restart the server process
- **AC04:** [Negative Test - Error Condition]
    - **Given** the server has a network timeout or connection failure when attempting to reach the `/health` endpoint
    - **When** a request is made to the `/health` endpoint
    - **Then** the system should respond with a `504 Gateway Timeout` error and log the failure, preventing the workflow from starting until the issue is resolved
#### REQ202511272348-US03
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** the LightRAG system is configured with a valid RAG service endpoint and API token, and the web server is running at `http://[::1]:8080`.
    - **When** a user sends an HTTP POST request to the `/query` endpoint via the web server.
    - **Then** the web server forwards the request to the RAG system’s `/query` API, retrieves relevant context from the vector database, and returns a structured response containing the answer and source document information.
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** the LightRAG system is configured with a valid RAG service endpoint and API token.
    - **When** a user sends an HTTP GET request to the `/query` endpoint with a malformed or empty query parameter.
    - **Then** the web server returns a 400 Bad Request error with a clear message indicating that the query parameter is required.
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** the LightRAG system is configured with a valid RAG service endpoint and API token.
    - **When** the RAG service is temporarily unavailable or returns a 500 error due to a backend failure.
    - **Then** the web server logs the error, returns a 503 Service Unavailable response with a message indicating that the RAG service is currently inaccessible, and maintains the request history for debugging.
- **AC04:** [Negative Test - Error Condition]
    - **Given** the LightRAG system is configured with an invalid or missing RAG API token.
    - **When** a user sends an HTTP GET request to the `/query` endpoint.
    - **Then** the web server returns a 401 Unauthorized response with a message indicating that authentication is required, and logs the authentication failure for security auditing.
#### REQ202511272348-US04
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** a user has configured the LightRAG environment with access to multiple RAG microservices (e.g., retrieval, generation, indexing) via a unified interface, and has defined a query that requires data from different microservices (e.g., user history, product catalog, real-time pricing).
    - **When** the user submits a query using the LightRAG system, which is designed to route the query to relevant microservices based on context and intent.
    - **Then** the system retrieves context from each microservice, aggregates the relevant data, and returns a unified, context-aware response to the user, ensuring that the final output is grounded in data from multiple sources.
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** the user’s query is ambiguous or lacks sufficient context to determine which microservices should be involved.
    - **When** the LightRAG system attempts to route the query to microservices but cannot identify a clear mapping due to insufficient context.
    - **Then** the system returns a response indicating uncertainty and suggests clarifying the query, with an option to provide additional context or select specific microservices.
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** one of the microservices is unavailable or returns an error due to a failure in communication or data access.
    - **When** the LightRAG system attempts to retrieve data from the failed microservice.
    - **Then** the system logs the error, continues to retrieve data from the remaining functional microservices, and returns a response that includes a partial result with a clear annotation about the missing data source.
- **AC04:** [Negative Test - Error Condition]
    - **Given** the user submits a query that is malformed or contains invalid syntax.
    - **When** the LightRAG system processes the query and encounters a syntax error during parsing.
    - **Then** the system responds with an appropriate error message indicating the invalid query format and provides guidance on how to correct it, without attempting to execute any microservice calls.
#### REQ202511272348-US05
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** a user has configured a LightRAG server with access to multiple RAG microservices (e.g., a movie database, a product catalog, and a knowledge base) and has defined a user prompt and a query question.
    - **When** the user sends a request to the LightRAG server specifying a calling order (e.g., "first retrieve from movie database, then from product catalog, then from knowledge base") and includes the user prompt and query question.
    - **Then** the LightRAG server executes the specified calling order by sequentially querying each microservice, retrieving relevant context, and combining the results to generate a final, context-aware response.
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** the user has configured a LightRAG server with access to multiple RAG microservices and has defined a user prompt and query question.
    - **When** the user sends a request to the LightRAG server with an invalid or non-existent calling order (e.g., "first retrieve from movie database, then from product catalog, then from non-existent microservice").
    - **Then** the LightRAG server validates the calling order and responds with an error message indicating that the specified microservice does not exist or is not available, and logs the error for monitoring purposes.
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** the user has configured a LightRAG server with access to multiple RAG microservices and has defined a user prompt and query question.
    - **When** the user sends a request to the LightRAG server with a calling order that includes redundant or overlapping microservices (e.g., "first retrieve from movie database, then from movie database again").
    - **Then** the LightRAG server detects the redundancy, skips the duplicate query, and proceeds with the remaining steps in the calling order to avoid unnecessary processing and maintain performance.
- **AC04:** [Negative Test - Error Condition]
    - **Given** the user has configured a LightRAG server with access to multiple RAG microservices and has defined a user prompt and query question.
    - **When** the user sends a request to the LightRAG server with a malformed or incomplete user prompt or query question (e.g., empty string or syntax error).
    - **Then** the LightRAG server validates the input and responds with a validation error message indicating the prompt or query is invalid, and does not initiate any microservice calls.
#### REQ202511272348-US06
- **AC01:** [Happy Path - Primary Success Scenario]
    - **Given** a user has access to a LightRAG platform and has configured multiple RAG microservices with distinct roles (e.g., document retrieval, real-time data analysis, product recommendations)
    - **When** the user sends a query that requires information from multiple specialized microservices
    - **Then** the LightRAG system dynamically routes the query to the appropriate microservices based on their roles, aggregates the responses, and presents a unified, context-aware output
- **AC02:** [Alternative Path - Expected Variation]
    - **Given** a user sends a query that is ambiguous or lacks sufficient context to determine which microservice should handle it
    - **When** the system receives the query and cannot assign it to a specific microservice
    - **Then** the system returns a response indicating the ambiguity and suggests possible interpretations or requests clarification from the user
- **AC03:** [Edge Case - Boundary Condition]
    - **Given** a user attempts to query a microservice that is currently unavailable or has failed due to a network or service outage
    - **When** the system detects the unavailability of a required microservice during query execution
    - **Then** the system logs the failure, notifies the user of the unavailability, and attempts to reroute the query to a fallback service or provides a partial response based on available data
- **AC04:** [Negative Test - Error Condition]
    - **Given** a user submits a malformed or invalid query (e.g., missing parameters, incorrect syntax)
    - **When** the system processes the query and identifies the error during routing or execution
    - **Then** the system responds with a clear error message explaining the issue and provides guidance on how to correct the input, while maintaining the integrity of the overall system